<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Happy Birthday</title>
  <style>
    :root{
      --card-bg: rgba(255,255,255,.74);
      --ink: #14161a;
      --muted: rgba(20,22,26,.72);
      --ring: rgba(20,22,26,.10);
    }
    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--ink);
      overflow: hidden;
      background:
        radial-gradient(900px 500px at 15% 20%, rgba(255, 182, 193, .55), transparent 60%),
        radial-gradient(700px 420px at 85% 30%, rgba(173, 216, 230, .55), transparent 60%),
        radial-gradient(900px 520px at 40% 85%, rgba(255, 233, 170, .55), transparent 60%),
        linear-gradient(135deg, #fbfbff, #f7fffb);
    }
    .sparkles{
      position: fixed; inset: 0;
      pointer-events: none;
      opacity: .55;
      background-image:
        radial-gradient(circle, rgba(255,255,255,.95) 0 1px, transparent 2px),
        radial-gradient(circle, rgba(255,255,255,.80) 0 1px, transparent 2px),
        radial-gradient(circle, rgba(255,255,255,.65) 0 1px, transparent 2px);
      background-size: 140px 140px, 220px 220px, 320px 320px;
      animation: drift 14s ease-in-out infinite alternate;
    }
    @keyframes drift{
      from { transform: translate3d(-10px,-10px,0); }
      to   { transform: translate3d(10px, 12px,0); }
    }

    .wrap{ height: 100%; display: grid; place-items: center; padding: 24px; }

    .card{
      width: min(900px, 92vw);
      padding: clamp(28px, 5vw, 54px);
      border-radius: 28px;
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,.6);
      box-shadow: 0 24px 70px rgba(0,0,0,.12), 0 1px 0 rgba(255,255,255,.6) inset;
      backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(135deg,
        rgba(255, 105, 180, .35),
        rgba(135, 206, 235, .30),
        rgba(255, 215, 0, .28)
      );
      filter: blur(18px);
      opacity: .55;
      z-index: 0;
    }
    .content{ position: relative; z-index: 1; }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      border: 1px solid var(--ring);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      font-weight: 600;
      font-size: 0.95rem;
      color: rgba(20,22,26,.85);
      user-select: none;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: linear-gradient(135deg, rgba(255,105,180,.95), rgba(255,215,0,.95));
      box-shadow: 0 0 0 4px rgba(255,105,180,.12);
    }

    h1{ margin: 18px 0 10px; font-size: clamp(2.4rem, 6vw, 4.2rem); letter-spacing: -0.02em; }
    .sub{ margin: 0 auto; max-width: 60ch; font-size: clamp(1.05rem, 2.1vw, 1.2rem); color: var(--muted); line-height: 1.55; }

    .stage{ margin: 22px auto 10px; display: grid; place-items: center; gap: 10px; }

    .tip{ font-size: 0.98rem; color: rgba(20,22,26,.55); user-select: none; }
    .status{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      color: rgba(20,22,26,.62);
      margin-top: 10px;
      user-select: none;
    }
    .meter{
      width: 180px;
      height: 10px;
      border-radius: 999px;
      background: rgba(20,22,26,.10);
      overflow: hidden;
      border: 1px solid rgba(20,22,26,.08);
    }
    .meter > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(135,206,235,.95), rgba(255,105,180,.95), rgba(255,215,0,.95));
      transition: width .08s linear;
    }

    .reveal{
      margin-top: 16px;
      font-size: clamp(2.0rem, 5.2vw, 4.0rem);
      font-weight: 900;
      letter-spacing: -0.02em;
      opacity: 0;
      transform: translateY(10px) scale(.99);
      transition: opacity .45s ease, transform .45s ease;
      user-select: none;
    }
    .reveal.show{ opacity: 1; transform: translateY(0) scale(1); }

    .actions{ margin-top: 20px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
    button{
      appearance: none;
      border: 1px solid rgba(20,22,26,.14);
      background: rgba(255,255,255,.75);
      color: rgba(20,22,26,.92);
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 14px 40px rgba(0,0,0,.08);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 18px 50px rgba(0,0,0,.10); background: rgba(255,255,255,.88); }
    button:active{ transform: translateY(0px); }
    .primary{
      border: 0;
      color: white;
      background: linear-gradient(135deg, rgba(255,105,180,.95), rgba(255,215,0,.95));
      text-shadow: 0 1px 12px rgba(0,0,0,.18);
    }

    /* Confetti */
    .confetti{ position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 5; }
    .piece{
      position: absolute;
      top: -12px;
      border-radius: 3px;
      opacity: 0;
      animation: fall var(--dur) linear var(--delay) forwards;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.12));
    }
    @keyframes fall{
      0%   { opacity: 0; transform: translate3d(var(--x), -30px, 0) rotate(0deg); }
      10%  { opacity: 1; }
      100% { opacity: 1; transform: translate3d(calc(var(--x) + var(--drift)), 110vh, 0) rotate(var(--rot)); }
    }

    /* Flame / smoke */
    .flameBtn{ cursor: pointer; transform-origin: center; transition: transform .15s ease, filter .15s ease, opacity .25s ease; }
    .flameBtn:hover{ transform: scale(1.04); filter: drop-shadow(0 10px 14px rgba(0,0,0,.18)); }
    .flame.off{ opacity: 0; pointer-events: none; }

    .smoke{ opacity: 0; }
    .smoke.play{ animation: smoke 1.2s ease-out forwards; }
    @keyframes smoke{
      0%   { opacity: 0; transform: translateY(0) scale(.9); }
      15%  { opacity: .55; }
      100% { opacity: 0; transform: translateY(-26px) scale(1.15); }
    }
  </style>
</head>

<body>
  <div class="sparkles" aria-hidden="true"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <div class="wrap">
    <main class="card" role="main">
      <div class="content">
        <div class="badge">
          <span class="dot" aria-hidden="true"></span>
          Enable mic, then blow to blow out the candle üé§üí®
        </div>

        <h1>Make a wish üïØÔ∏è</h1>
        <p class="sub">
          Click <b>Enable microphone</b>, then blow near your mic. (You can also tap the flame.)
        </p>

        <div class="stage">
          <svg width="360" height="260" viewBox="0 0 360 260" role="img" aria-label="Birthday cake with a candle">
            <ellipse cx="180" cy="230" rx="120" ry="20" fill="rgba(20,22,26,.12)"></ellipse>
            <ellipse cx="180" cy="226" rx="120" ry="18" fill="rgba(255,255,255,.85)"></ellipse>

            <ellipse cx="180" cy="210" rx="95" ry="14" fill="rgba(20,22,26,.10)"></ellipse>

            <rect x="90" y="135" width="180" height="80" rx="22" fill="rgba(255, 182, 193, .92)"></rect>
            <rect x="90" y="135" width="180" height="26" rx="22" fill="rgba(255,255,255,.55)"></rect>

            <path d="M110 150 C120 165, 130 165, 140 150 C150 135, 160 135, 170 150 C180 165, 190 165, 200 150 C210 135, 220 135, 230 150 C240 165, 250 165, 260 150"
                  fill="none" stroke="rgba(255,255,255,.65)" stroke-width="10" stroke-linecap="round"></path>

            <rect x="115" y="95" width="130" height="60" rx="20" fill="rgba(173, 216, 230, .92)"></rect>
            <rect x="115" y="95" width="130" height="20" rx="20" fill="rgba(255,255,255,.55)"></rect>

            <rect x="171" y="50" width="18" height="58" rx="8" fill="rgba(255,255,255,.92)" stroke="rgba(20,22,26,.10)"></rect>
            <path d="M171 60 L189 60" stroke="rgba(255,105,180,.65)" stroke-width="4" stroke-linecap="round"></path>
            <path d="M171 72 L189 72" stroke="rgba(255,215,0,.6)" stroke-width="4" stroke-linecap="round"></path>
            <path d="M171 84 L189 84" stroke="rgba(135,206,235,.6)" stroke-width="4" stroke-linecap="round"></path>

            <rect x="178.5" y="44" width="3" height="8" rx="2" fill="rgba(20,22,26,.55)"></rect>

            <g id="smoke" class="smoke">
              <circle cx="180" cy="38" r="6" fill="rgba(20,22,26,.18)"></circle>
              <circle cx="190" cy="30" r="8" fill="rgba(20,22,26,.12)"></circle>
              <circle cx="172" cy="26" r="7" fill="rgba(20,22,26,.10)"></circle>
            </g>

            <g id="flame" class="flameBtn" tabindex="0" role="button" aria-label="Blow out the candle">
              <path d="M180 12
                       C170 22, 168 34, 176 42
                       C184 50, 196 46, 198 36
                       C200 26, 192 18, 186 14
                       C190 22, 186 26, 180 12 Z"
                    fill="rgba(255,140,0,.95)"></path>
              <path d="M180 18
                       C174 26, 174 34, 179 38
                       C184 42, 190 40, 192 34
                       C194 28, 188 24, 184 22
                       C186 26, 184 28, 180 18 Z"
                    fill="rgba(255,255,255,.75)"></path>
            </g>
          </svg>

          <div class="tip">Blow into the mic üí® (or tap the flame)</div>

          <div class="status">
            <span id="micLabel">Mic: off</span>
            <div class="meter" aria-label="Blow strength meter"><div id="meterFill"></div></div>
          </div>
        </div>

        <div id="reveal" class="reveal">Happy Birthday üéÇüéâ</div>

        <div class="actions">
          <button class="primary" id="enableMic">Enable microphone üé§</button>
          <button id="celebrate">More confetti üéâ</button>
          <button id="reset">Relight üî•</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ---------- Confetti ----------
    const confettiRoot = document.getElementById("confetti");
    function rand(min, max){ return Math.random() * (max - min) + min; }
    function popConfetti(count = 90){
      const colors = [
        "rgba(255,105,180,.95)",
        "rgba(255,215,0,.95)",
        "rgba(135,206,235,.95)",
        "rgba(152,251,152,.95)",
        "rgba(186,85,211,.92)"
      ];
      for(let i=0; i<count; i++){
        const piece = document.createElement("span");
        piece.className = "piece";
        const left = rand(0, 100);
        piece.style.left = `${left}vw`;
        piece.style.background = colors[Math.floor(Math.random() * colors.length)];
        piece.style.setProperty("--x", `${left}vw`);
        piece.style.setProperty("--drift", `${rand(-12, 12)}vw`);
        piece.style.setProperty("--rot", `${rand(360, 1080)}deg`);
        piece.style.setProperty("--dur", `${rand(1.8, 3.4)}s`);
        piece.style.setProperty("--delay", `${rand(0, 0.35)}s`);
        piece.style.width = `${rand(8, 12)}px`;
        piece.style.height = `${rand(12, 18)}px`;
        confettiRoot.appendChild(piece);
        piece.addEventListener("animationend", () => piece.remove());
      }
    }

    // ---------- Elements ----------
    const flame = document.getElementById("flame");
    const smoke = document.getElementById("smoke");
    const reveal = document.getElementById("reveal");
    const enableMicBtn = document.getElementById("enableMic");
    const celebrateBtn = document.getElementById("celebrate");
    const resetBtn = document.getElementById("reset");
    const micLabel = document.getElementById("micLabel");
    const meterFill = document.getElementById("meterFill");

    // ---------- Optional cheer sound ----------
    let audioCtx = null;
    function playCheer(){
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = audioCtx || new AudioContext();
      const notes = [523.25, 659.25, 783.99, 1046.5]; // C, E, G, C
      let t = audioCtx.currentTime;
      for (const freq of notes){
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "triangle";
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.22, t + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(t);
        osc.stop(t + 0.25);
        t += 0.18;
      }
    }

    // ---------- Candle logic ----------
    let blownOut = false;

    function blowOut(){
      if (blownOut) return;
      blownOut = true;

      flame.classList.add("flame", "off");

      smoke.classList.remove("play");
      void smoke.getBoundingClientRect();
      smoke.classList.add("play");

      reveal.classList.add("show");

      popConfetti(120);
      playCheer();
    }

    function relight(){
      blownOut = false;
      flame.classList.remove("off");
      reveal.classList.remove("show");
      popConfetti(35);
    }

    flame.addEventListener("click", blowOut);
    flame.addEventListener("touchstart", (e) => { e.preventDefault(); blowOut(); }, {passive:false});
    flame.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); blowOut(); }
    });

    celebrateBtn.addEventListener("click", () => popConfetti(110));
    resetBtn.addEventListener("click", relight);

    // ---------- Mic blow detection ----------
    // Strategy: measure short-term loudness (RMS). Blow = a quick sustained spike above a threshold.
    let micStream = null;
    let analyser = null;
    let data = null;
    let rafId = null;

    // Tuning knobs (safe defaults)
    const THRESHOLD = 0.12;     // loudness threshold (0..1) ‚Äî increase if too sensitive
    const HOLD_MS = 220;        // require it stays above threshold for a moment
    const COOLDOWN_MS = 1200;   // ignore new blows for a bit

    let aboveSince = null;
    let lastTrigger = 0;

    function computeRMS(byteTimeDomain){
      // byteTimeDomain: 0..255, center 128
      let sumSq = 0;
      for (let i=0; i<byteTimeDomain.length; i++){
        const v = (byteTimeDomain[i] - 128) / 128; // approx -1..1
        sumSq += v * v;
      }
      return Math.sqrt(sumSq / byteTimeDomain.length);
    }

    function loop(){
      if (!analyser || !data) return;

      analyser.getByteTimeDomainData(data);
      const rms = computeRMS(data);

      // meter (visual only)
      const pct = Math.min(100, Math.max(0, (rms / 0.25) * 100));
      meterFill.style.width = pct.toFixed(1) + "%";

      const now = performance.now();

      if (!blownOut && (now - lastTrigger) > COOLDOWN_MS){
        if (rms >= THRESHOLD){
          if (aboveSince === null) aboveSince = now;
          if ((now - aboveSince) >= HOLD_MS){
            lastTrigger = now;
            aboveSince = null;
            blowOut();
          }
        } else {
          aboveSince = null;
        }
      }

      rafId = requestAnimationFrame(loop);
    }

    async function enableMic(){
      try{
        // Some browsers need this on HTTPS/localhost + user gesture (button click).
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: false
          }
        });

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = audioCtx || new AudioContext();

        const source = audioCtx.createMediaStreamSource(micStream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        data = new Uint8Array(analyser.fftSize);
        source.connect(analyser);

        micLabel.textContent = "Mic: on (blow now)";
        enableMicBtn.textContent = "Microphone enabled ‚úÖ";
        enableMicBtn.disabled = true;

        popConfetti(25);
        if (rafId) cancelAnimationFrame(rafId);
        loop();
      } catch (err){
        micLabel.textContent = "Mic: blocked/unavailable";
        alert(
          "Could not access the microphone.\n\n" +
          "Tips:\n" +
          "‚Ä¢ Use HTTPS or localhost\n" +
          "‚Ä¢ Allow mic permission in your browser\n" +
          "‚Ä¢ Try Chrome / Edge / Safari on a real device\n\n" +
          "You can still tap the flame to blow it out."
        );
      }
    }

    enableMicBtn.addEventListener("click", enableMic);

    // subtle confetti on load
    window.addEventListener("load", () => popConfetti(35));
  </script>
</body>
</html>
